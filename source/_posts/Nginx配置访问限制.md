---
title: Nginx配置访问限制
date: 2016-03-17 13:40:24
tags: [nginx, 运维, 安全]
---

使用 ngxin 时添加IP访问控制是常见需求, 最近遇到该需求, 简单记录如下.

## 模块依赖
 nginx 的 IP 访问控制依赖于内置的 `ngx_http_access_module`. 在默认情况下, 这个包在编译中是安装的, 除非编译过程中显示指定`--without ngx_http_access_module`.

## 配置方法

样例配置如下, example.conf
```nginx
location / {
    deny  192.168.1.1;
    allow 192.168.1.0/24;
    allow 10.1.1.0/16;
    allow 2001:0db8::/32;
    deny  all;
}

```

<!-- more -->

写完之后 include 到配置文件即可
`include /path/to/your_conf/*.conf;`
PS: 记得加分号, `;`

nginx 对于匹配顺序有如下规定: 任何一个 IP 地址, 访问了该 location 之后, 则`从上到下`对规则进行匹配, `漏斗`原则~ . ~ .
举例如下:

- `192.168.1.1`: 进入之后匹配到第一个`IP/IP 段`, 则执行对应的规则 `deny`, 返回.
- `192.168.1.12`: 进入之后第一个未匹配, 跳过; 匹配到第二个, 执行对应规则 `allow`, 返回.
- `172.168.1.101`: 进入之后前四个都未匹配到, 匹配最后一个 `all`, 执行 `deny`, 返回.

## 配置语法

```
    Syntax: (allow|deny) address | CIDR | unix: | all
    Default: —
    Context: http, server, location, limit_except
```

语法设置可以为 `allow|deny` 两个关键字, 后面的对应属性可以为 IP 地址/地址段(可以使ipv4 或者 ipv6), CIRD(见[附1](#tip1)), `unix:`, `all`, 无默认值.
配置模块可以出现在 nginx 的 `http{}`, `server{}`, `location{}`, `limit_except{}` 模块.
如果属性值配置为`unix:`, 则会允许或拒绝所有 Unix 域socket.(该选项只在 nginx 1.5.1之后的版本生效)

## 可用的第三方配置模块
 nginx 只提供了简单的静态 IP 控制, 不过在服务端接入层用于做长效黑名单控制已经足够了, 如果针对访问控制进行动态规则调整, 我找到了`这货`
 [ngx_white_black_list](https://github.com/codehunte/ngx_white_black_list/blob/master/white_black_list.txt')


简单说到这里, 其实还是挺简单的, 注意理一下匹配规则.

* [附1](#tip1):

`无类别域间路由`

>无类别域间路由（Classless Inter-Domain Routing、CIDR）是一个用于给用户分配IP地址以及在互联网上有效地路由IP数据包的对IP地址进行归类的方法。
在域名系统出现之后的第一个十年里，基于分类网络进行地址分配和路由IP数据包的设计就已明显显得可扩充性不足 （参见RFC 1517）。为了解决这个问题，互联网工程工作小组在1993年发布了一新系列的标准——RFC 1518和RFC 1519——以定义新的分配IP地址块和路由IPv4数据包的方法。
一个IP地址包含两部分：标识网络的前缀和紧接着的在这个网络内的主机地址。在之前的分类网络中，IP地址的分配把IP地址的32位按每8位为一段分开。这使得前缀必须为8，16或者24位。因此，可分配的最小的地址块有256（24位前缀，8位主机地址，28=256）个地址，而这对大多数企业来说太少了。大一点的地址块包含65536（16位前缀，16位主机，216=65536）个地址，而这对大公司来说都太多了。这导致不能充分使用IP地址和在路由上的不便，因为大量的需要单独路由的小型网络（C类网络）因在地域上分得很开而很难进行聚合路由，于是给路由设备增加了很多负担。

<

>无类别域间路由是基于可变长子网掩码（VLSM）来进行任意长度的前缀的分配的。在RFC 950（1985）中有关于可变长子网掩码的说明。CIDR包括：
指定任意长度的前缀的可变长子网掩码技术。遵从CIDR规则的地址有一个后缀说明前缀的位数，例如：192.168.0.0/16。这使得对日益缺乏的IPv4地址的使用更加有效。
将多个连续的前缀聚合成超网，以及，在互联网中，只要有可能，就显示为一个聚合的网络，因此在总体上可以减少路由表的表项数目。聚合使得互联网的路由表不用分为多级，并通过VLSM逆转“划分子网”的过程。
根据机构的实际需要和短期预期需要而不是分类网络中所限定的过大或过小的地址块来管理IP地址的分配的过程。
因为在IPv6中也使用了IPv4的用后缀指示前缀长度的CIDR，所以IPv4中的分类在IPv6中已不再使用。

<

>摘自维基百科: [无类别域间路由]('https://zh.wikipedia.org/wiki/%E6%97%A0%E7%B1%BB%E5%88%AB%E5%9F%9F%E9%97%B4%E8%B7%AF%E7%94%B1')
